#!/bin/bash

NAMESPACE=${NAMESPACE:-default}
TYPE=${TYPE:-Opaque}

if [ -z "$SECRET_NAME" ]; then
    echo "ERROR: Secret name is empty or unset"
    exit 1
fi

PKI_DIR=/etc/openvpn/pki

KEY=$(base64 $PKI_DIR/private/${EASYRSA_REQ_CN}.key | tr -d '\n'  )
CA=$(base64 $PKI_DIR/ca.crt | tr -d '\n'  )
CERT=$(base64 $PKI_DIR/issued/${EASYRSA_REQ_CN}.crt | tr -d '\n' )
DH=$(base64 $PKI_DIR/dh.pem | tr -d '\n' )
TLS_AUTH=$(base64 $PKI_DIR/ta.key | tr -d '\n' )
CLIENT_KEY=$(base64 $PKI_DIR/private/admin.key | tr -d '\n' )
CLIENT=$(base64 /etc/openvpn/clients/admin/admin-combined.ovpn | tr -d '\n' )

cat << EOF | kubectl apply -f -
{
 "apiVersion": "v1",
 "kind": "Secret",
 "metadata": {
   "name": "$SECRET_NAME",
   "namespace": "$NAMESPACE"
 },
 "data": {
   "key": "$KEY",
   "ca": "$CA",
   "cert": "$CERT",
   "dh": "$DH",
   "tls_auth": "$TLS_AUTH",
   "client_key": "$CLIENT_KEY",
   "client": "$CLIENT"
 },
 "type": "$TYPE"
}
EOF